---
title: 如何通过贷款计划获取总期数和当期期数
reward: true
toc: true
declare: true
tags: 金融
---
未经作者授权禁止转载 作者：Chaierss https://chaierss.cn
---

### <font color="#798ba9"> 前言 </font>

在计算贷款的贷款期数和当前期数时，核心只存了账户的贷款计划，如何通过这个贷款计划获取总期数和当期期数呢？

<!--more-->

### <font color="#798ba9"> 1.条件整理 </font>

已知条件：即涉及到哪些表的哪些字段
账户表（账户号），贷款计划表（账户号,贷款当期开始日，贷款当期结束日，还款金额)

<br>

### <font color="#798ba9"> 2.思路想法 </font>

可以先用查询一下某一个账户的还款计划，例如以下虚拟账户的账户的一个贷款计划为

```
账户号1 20210101 20210301 10000
账户号1 20210301 20210601 20000
账户号1 20210601 20210901 30000
账户号1 20210901 20211201 40000
```

由此可见 此账户做了4期贷款,每期还款计划金额
那么获取其总期数就很明显了，根据账户分组，获取其COUNT()即可

```
WITH 贷款总期数 AS (
    SELECT COUNT(*) X,
    A.账户号 
    FROM 账户表 A
    LEFT JOIN 贷款计划表 B
    ON A.账户号 = B.账户号
    GROUP BY A.账户号)
```

接下来就是当期期数的判断，在获取了总期数明细后，其实只需要判断当期时间中有多少个当期开始日即可

```
WITH 贷款当期期数 AS (
    SELECT COUNT(*) X,
    A.账户号 
    FROM 账户表 A
    LEFT JOIN 贷款计划表 B
    ON A.账户号 = B.账户号
    AND B.贷款当期开始日 <= TO_DATE(当期时间,'YYYYMMDD')
    GROUP BY A.账户号)
```

<br>

### <font color="#798ba9"> 3.调整完善 </font>

还有一些具体遇到的问题例如：

> 还款计划中有的会存发放贷款记录，需要根据其字段进行剔除
关于提前还款等逻辑还需要待讨论，此表为还款计划表，如提前还款应该根据账户状态进行判断
关于当前时间，贷款还未开始的当前期数可以NVL(贷款当期期数.X,0)

<br>

### 本文作者记录笔记心得，如有错误欢迎指正
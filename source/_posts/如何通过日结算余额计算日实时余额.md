---
title: 如何通过日结算余额计算日实时余额
reward: true
toc: true
declare: true
tags: 金融
---
未经作者授权禁止转载 作者：Chaierss https://chaierss.cn
---

### <font color="#798ba9"> 前言 </font>

在计算账户的明细余额时，核心只存了账户的日结算余额，如何通过交易流水来计算日实时余额呢？

<!--more-->

### <font color="#798ba9"> 1.条件整理 </font>

已知条件：即涉及到哪些表的哪些字段
账户表（账户号），日余额表（账户号，日余额），流水表（流水号，交易时间，交易金额，借贷方向，账户号）

<br>

### <font color="#798ba9"> 2.思路想法 </font>

先试着查询一下 某一个账户 在某一天的 交易明细
例如：在628这一天的某一个虚拟账户的流水如下

```
select 账户号,流水号,交易时间,交易金额,借贷方向 from 流水表 where 账户号 in ('xxxxxxxx')
and key_dt = date'2021-06-28'
order by 流水号

账户号 流水号1    2021/06/28  3000.00 借
账户号 流水号2    2021/06/28  4000.00 贷
```

这个就是一个模拟账号在这一天的交易流水，接下来就是模拟其实时余额流水。
就拿这个虚拟账户举例，假设其27日的余额为1000，28日的日余额为0。

> 理想创建流水为：

```
账户号 流水号 交易时间 实时余额

账户号 流水号1 2021/06/28 4000.00 
账户号 流水号2 2021/06/28 0.00
```

第一个实时余额是 1000 + (3000) = 4000
第二个实时余额是 1000 + (3000 - 4000) = 0

<br>

那么实时余额的公式建模为：

```
上日余额 + 流水号1时的交易额
上日余额 + 流水号1时的交易额 + 流水号2时的交易额
上日余额 + 流水号1时的交易额 + 流水号2时的交易额 + 流水号3时的交易额

上日余额 + 流水号1时的交易额 + 流水号2时的交易额 + 流水号3时的交易额 + ... + 流水号n时的交易额
```

> 流水号n时的交易额则根据其借贷方向做一个正负判断

```
DECODE(借贷方向,'借',交易金额,'贷',交易金额*(-1))
```

<br>

### <font color="#798ba9"> 3.明细实现 </font>

思路明确之后就是具体实现。

> 通过1：N = N实现1个账户的N笔流水
通过上述建交易额分组排序，实现N笔流水的实时余额加减

```
WITH 实时余额加减临时表 AS 
     (SELECT 流水号,账户号,交易时间,
      SUM(DECODE(借贷方向,'借',交易金额,'贷',交易金额*(-1))) OVER (PARTITION BY 账户号 ORDER BY 流水号) 实时交易额
      FROM 流水表
      WHERE 交易时间 = TO_DATE('20210628','YYYYMMDD'))
```

接下来就是
获取其上日余额,关联此实时余额加减临时表后进行实时余额的计算

```
上日余额 + 实时余额加减临时表.实时交易额
```

<br>

### <font color="#798ba9"> 4.调整完善 </font>

还有其他一些实际遇到的问题，例如临时表的排序依靠流水号需要流水号为从先到后，不然会出现先贷后借，实时余额为负的情况；
关联时间的字段选择，交易时间和过账时间哪个为实际交易时间的问题等等都需要讨论确定。 　

<br>

### 本文作者记录笔记心得，如有错误欢迎指正